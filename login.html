<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login ‚Äì Sipyora Institute</title>
  <link rel="stylesheet" href="css/style.css"/>
</head>
<body class="login-page">

  <div class="toast-container"></div>

  <div class="login-card">
    <div class="login-logo">
      <h1>Sip<span>yora</span></h1>
      <p>Institute Management System</p>
    </div>

    <div class="role-tabs">
      <button class="role-tab active" onclick="setRole('admin')">üîê Admin</button>
      <button class="role-tab" onclick="setRole('teacher')">üë©‚Äçüè´ Teacher</button>
    </div>

    <div class="form-group">
      <label>Email Address</label>
      <input type="email" id="emailInput" placeholder="Enter your email" autocomplete="email"/>
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="passwordInput" placeholder="Enter your password"
        autocomplete="current-password"
        onkeydown="if(event.key==='Enter') doLogin()"/>
    </div>
    <div id="loginError" style="color:var(--danger);font-size:0.85rem;margin-bottom:14px;display:none;
      padding:10px 14px;background:rgba(231,76,60,0.1);border-radius:10px;"></div>
    <button class="btn btn-primary" onclick="doLogin()" id="loginBtn">Sign In</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="js/firebase.js"></script>

  <script>
    var selectedRole = 'admin';
    var _redirecting = false;

    function setRole(role) {
      selectedRole = role;
      var tabs = document.querySelectorAll('.role-tab');
      tabs[0].classList.toggle('active', role === 'admin');
      tabs[1].classList.toggle('active', role === 'teacher');
    }

    // ‚îÄ‚îÄ If already logged in, go straight to dashboard ‚îÄ‚îÄ
    // Use a short timeout so Firebase has time to read stored session
    // before we decide to stay on login page.
    auth.onAuthStateChanged(function(user) {
      if (user && !_redirecting) {
        _redirecting = true;
        window.location.href = 'index.html';
      }
    });

    function doLogin() {
      var email = document.getElementById('emailInput').value.trim();
      var pass  = document.getElementById('passwordInput').value;
      var btn   = document.getElementById('loginBtn');
      var err   = document.getElementById('loginError');

      if (!email || !pass) {
        err.textContent = 'Please fill in all fields.';
        err.style.display = 'block';
        return;
      }
      if (selectedRole === 'admin' && !isAdmin(email)) {
        err.textContent = 'This email is not registered as admin.';
        err.style.display = 'block';
        return;
      }

      btn.textContent = 'Signing in‚Ä¶';
      btn.disabled = true;
      err.style.display = 'none';

      // setPersistence then signIn ‚Äî this ensures the token is saved to
      // IndexedDB (LOCAL) before we navigate away
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
        .then(function() {
          return auth.signInWithEmailAndPassword(email, pass);
        })
        .then(function() {
          // onAuthStateChanged above handles the redirect
        })
        .catch(function(e) {
          var msg = 'Login failed. Check your email and password.';
          if (e.code === 'auth/user-not-found')    msg = 'No account found with this email.';
          if (e.code === 'auth/wrong-password')    msg = 'Incorrect password.';
          if (e.code === 'auth/invalid-email')     msg = 'Invalid email address.';
          if (e.code === 'auth/too-many-requests') msg = 'Too many attempts. Try again later.';
          err.textContent = msg;
          err.style.display = 'block';
          btn.textContent = 'Sign In';
          btn.disabled = false;
        });
    }
  </script>
</body>
</html>