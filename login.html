<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login ‚Äì Sipyora Institute</title>
  <link rel="stylesheet" href="css/style.css"/>
</head>
<body class="login-page">

  <div class="toast-container"></div>

  <div class="login-card">
    <div class="login-logo">
      <h1>Sip<span>yora</span></h1>
      <p>Institute Management System</p>
    </div>

    <div class="role-tabs">
      <button class="role-tab active" id="tabAdmin"  onclick="setRole('admin')">üîê Admin</button>
      <button class="role-tab"        id="tabTeacher" onclick="setRole('teacher')">üë©‚Äçüè´ Teacher</button>
    </div>

    <div class="form-group">
      <label>Email Address</label>
      <input type="email" id="emailInput" placeholder="Enter your email" autocomplete="email"/>
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="passwordInput" placeholder="Enter your password"
        autocomplete="current-password"
        onkeydown="if(event.key==='Enter') doLogin()"/>
    </div>

    <div id="loginError" style="display:none;color:var(--danger);font-size:0.85rem;
      margin-bottom:14px;padding:10px 14px;background:rgba(231,76,60,0.1);
      border-radius:10px;border:1px solid rgba(231,76,60,0.2);"></div>

    <button class="btn btn-primary" onclick="doLogin()" id="loginBtn">Sign In</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="js/firebase.js"></script>
  <script>
    var selectedRole  = 'admin';
    var alreadyGoing  = false;   // prevent double-redirect

    // ‚îÄ‚îÄ If already logged in ‚Üí go straight to dashboard ‚îÄ‚îÄ
    // Wait for authStateReady so we don't check before IndexedDB is read
    var readyP = (typeof auth.authStateReady === 'function')
      ? auth.authStateReady()
      : new Promise(function(res) {
          var u = auth.onAuthStateChanged(function(){ u(); setTimeout(res,50); });
        });

    readyP.then(function() {
      if (auth.currentUser && !alreadyGoing) {
        alreadyGoing = true;
        window.location.replace('index.html');
      }
    });

    function setRole(role) {
      selectedRole = role;
      document.getElementById('tabAdmin').classList.toggle('active',   role === 'admin');
      document.getElementById('tabTeacher').classList.toggle('active', role === 'teacher');
    }

    function showErr(msg) {
      var e = document.getElementById('loginError');
      e.textContent = msg;
      e.style.display = 'block';
    }

    function doLogin() {
      var email = document.getElementById('emailInput').value.trim();
      var pass  = document.getElementById('passwordInput').value;
      var btn   = document.getElementById('loginBtn');
      document.getElementById('loginError').style.display = 'none';

      if (!email || !pass) { showErr('Please fill in all fields.'); return; }
      if (selectedRole === 'admin' && !isAdmin(email)) {
        showErr('This email is not registered as admin.'); return;
      }

      btn.textContent = 'Signing in‚Ä¶';
      btn.disabled = true;

      // Set LOCAL persistence first ‚Äî this ensures the token is written
      // to IndexedDB (not just memory/session) before we navigate away.
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
        .then(function() {
          return auth.signInWithEmailAndPassword(email, pass);
        })
        .then(function() {
          localStorage.setItem('sipyora_logged_in', '1');
          localStorage.setItem('sipyora_role', selectedRole);
          alreadyGoing = true;
          window.location.replace('index.html');
        })
        .catch(function(e) {
          var msgs = {
            'auth/user-not-found':    'No account found with this email.',
            'auth/wrong-password':    'Incorrect password.',
            'auth/invalid-email':     'Invalid email address.',
            'auth/invalid-credential':'Incorrect email or password.',
            'auth/too-many-requests': 'Too many attempts. Wait a few minutes.',
          };
          showErr(msgs[e.code] || 'Login failed. Check your credentials.');
          btn.textContent = 'Sign In';
          btn.disabled = false;
        });
    }
  </script>
</body>
</html>