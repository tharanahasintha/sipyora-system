<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teachers ‚Äì Sipyora Institute</title>
  <link rel="stylesheet" href="../css/style.css"/>
</head>
<body>
  <div class="toast-container"></div>

  <div class="modal-overlay" id="addTeacherModal">
    <div class="modal">
      <div class="modal-header">
        <h3>üë©‚Äçüè´ Add Teacher</h3>
        <button class="close-btn" onclick="closeModal('addTeacherModal')">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group"><label>Full Name *</label><input type="text" id="tName" placeholder="Teacher name"/></div>
          <div class="form-group"><label>Email *</label><input type="email" id="tEmail" placeholder="teacher@email.com"/></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Phone</label><input type="tel" id="tPhone" placeholder="Contact number"/></div>
        </div>
        <div class="form-group">
          <label>Assigned Subjects *</label>
          <div class="subject-check-list" id="teacherSubjectList"><p style="color:var(--text-muted);">Loading...</p></div>
        </div>
        <div class="form-group">
          <label>Grades Handling</label>
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;" id="gradeCheckboxes"></div>
        </div>
        <div style="background:rgba(243,156,18,0.1);border:1px solid rgba(243,156,18,0.3);border-radius:10px;padding:12px;margin-top:8px;">
          <p style="font-size:0.83rem;color:var(--warning);">‚ö†Ô∏è After adding, create this teacher's Firebase Auth account manually in Firebase Console ‚Üí Authentication ‚Üí Add User, using the same email.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('addTeacherModal')">Cancel</button>
        <button class="btn btn-primary" onclick="addTeacher()">Add Teacher</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../js/firebase.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/layout.js"></script>
  <script>
    var allTeachers = [];
    var allSubjects = [];

    function onPageReady(user, role) {
      if (role !== 'admin') {
        document.getElementById('pageContent').innerHTML = '<div class="empty-state"><div class="icon">üîí</div><h3>Admin Only</h3><p>You need admin access to view this page.</p></div>';
        return;
      }
      document.getElementById('topbarActions').innerHTML = '<button class="btn btn-primary" onclick="openAddTeacherModal()">+ Add Teacher</button>';
      loadData();
    }

    function loadData() {
      Promise.all([
        db.collection('subjects').orderBy('name').get(),
        db.collection('teachers').orderBy('name').get()
      ]).then(function(results) {
        allSubjects = results[0].docs.map(function(d) { return Object.assign({id: d.id}, d.data()); });
        allTeachers = results[1].docs.map(function(d) { return Object.assign({id: d.id}, d.data()); });
        renderTeachers();
      });
    }

    function renderTeachers() {
      var content = document.getElementById('pageContent');
      var rows = allTeachers.length === 0
        ? '<tr><td colspan="6"><div class="empty-state"><div class="icon">üë©‚Äçüè´</div><h3>No teachers yet</h3><p>Add your first teacher</p></div></td></tr>'
        : allTeachers.map(function(t, i) {
          var chips = (t.subjects||[]).map(function(s) { return '<span class="chip">' + s + '</span>'; }).join('');
          var grades = (t.grades||[]).map(function(g) { return '<span class="badge badge-info">G' + g + '</span>'; }).join('');
          return '<tr><td style="color:var(--text-muted);">' + (i+1) + '</td><td><div style="display:flex;align-items:center;gap:10px;"><div style="width:34px;height:34px;background:var(--surface);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.85rem;">' + t.name.charAt(0) + '</div><strong>' + t.name + '</strong></div></td><td style="color:var(--text-muted);">' + t.email + '</td><td><div class="subject-chips">' + chips + '</div></td><td><div style="display:flex;flex-wrap:wrap;gap:4px;">' + grades + '</div></td><td><button class="btn btn-sm btn-danger btn-icon" onclick="removeTeacher(\'' + t.id + '\',\'' + t.name.replace(/'/g,'') + '\')" title="Remove">üóëÔ∏è</button></td></tr>';
        }).join('');

      content.innerHTML = '<div class="card"><div class="card-header"><h3>All Teachers (' + allTeachers.length + ')</h3></div><div class="table-wrap"><table><thead><tr><th>#</th><th>Name</th><th>Email</th><th>Subjects</th><th>Grades</th><th>Actions</th></tr></thead><tbody>' + rows + '</tbody></table></div></div>';
    }

    function openAddTeacherModal() {
      var list = document.getElementById('teacherSubjectList');
      list.innerHTML = allSubjects.length === 0
        ? '<p style="color:var(--text-muted);font-size:0.85rem;">No subjects. Add subjects first.</p>'
        : allSubjects.map(function(s) { return '<div class="subject-check-item"><input type="checkbox" id="tsub_' + s.id + '" value="' + s.name + '"/><label for="tsub_' + s.id + '">' + s.name + '</label></div>'; }).join('');

      var gc = document.getElementById('gradeCheckboxes');
      gc.innerHTML = [6,7,8,9,10,11].map(function(g) {
        return '<div style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--primary);border-radius:8px;border:1px solid var(--border);"><input type="checkbox" id="tg' + g + '" value="' + g + '" style="accent-color:var(--accent);"/><label for="tg' + g + '" style="font-size:0.85rem;cursor:pointer;">Grade ' + g + '</label></div>';
      }).join('');

      document.getElementById('tName').value = '';
      document.getElementById('tEmail').value = '';
      document.getElementById('tPhone').value = '';
      openModal('addTeacherModal');
    }

    function addTeacher() {
      var name = document.getElementById('tName').value.trim();
      var email = document.getElementById('tEmail').value.trim();
      var phone = document.getElementById('tPhone').value.trim();
      var subjects = Array.from(document.querySelectorAll('#teacherSubjectList input:checked')).map(function(c) { return c.value; });
      var grades = Array.from(document.querySelectorAll('[id^="tg"]:checked')).map(function(c) { return parseInt(c.value); });
      if (!name || !email) return showToast('Name and email required', 'error');
      if (subjects.length === 0) return showToast('Assign at least one subject', 'error');
      db.collection('teachers').add({ name: name, email: email, phone: phone, subjects: subjects, grades: grades, createdAt: firebase.firestore.FieldValue.serverTimestamp() })
        .then(function() {
          showToast('Teacher "' + name + '" added! Now create their Firebase Auth account with email: ' + email, 'success');
          closeModal('addTeacherModal');
          loadData();
        }).catch(function(e) { showToast('Error: ' + e.message, 'error'); });
    }

    function removeTeacher(id, name) {
      if (!confirm('Remove teacher "' + name + '"?')) return;
      db.collection('teachers').doc(id).delete().then(function() {
        showToast('Teacher removed', 'info');
        loadData();
      }).catch(function(e) { showToast('Error: ' + e.message, 'error'); });
    }

    buildLayout('Teachers', 'teachers', '../');
  </script>
</body>
</html>